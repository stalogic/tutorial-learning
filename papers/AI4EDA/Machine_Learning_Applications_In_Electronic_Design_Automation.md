# Machine Learning Applications in Electronic Design Automation

## Preface

### Background
+ 大多数电子设计自动化（EDA）问题本质上都是NP难问题，因此不存在用于找到最优解的多项式时间算法，这是它们的基本限制。
+  the fundamental limit that most EDA problems are NP hard and therefore have no polynomial-time algorithms for optimal solutions.

### 目录
+ 章节1至6主要关注基于机器学习的设计预测技术。
+ 第二部分（章节7至12）围绕基于机器学习的设计优化技术展开。
+ 第三部分（章节13至18）强调将机器学习技术应用于电子设计自动化（EDA）中的各种特定领域。
+ Chaps. 1–6, is focused  on machine learning-based design prediction techniques.
+ Part II (Chaps. 7–12) is centered around machine learning-based design optimization techniques.
+ Part III (Chaps. 13–18) emphasizes the application of ML techniques on various specifific domains in EDA.

## Chapter 1: ML for Design QoR Prediction

### 1.1 Introduction

半导体技术缩放面临多种挑战，包括线距缩小、图案化灵活性、晶圆加工成本、互连电阻和制造变异性。摩尔定律的横向缩放在5纳米/3纳米节点后难以继续。为了延续行业缩放路径，正在探索缩放助推器、新器件架构、设计技术协同优化和垂直维度利用等策略。同时，也在积极研究多种新型计算范式。尽管如此，先进技术节点新产品设计的成本过高已成为行业危机。随着技术进步和产品效益增量减少，成本压力增加。**目前，提高IC设计的质量结果（QoR）成为焦点**，尤其是在不增加设计资源的情况下。通过使用机器学习（ML）技术，无论是在EDA工具内部还是周围，都是提高产品设计结果、实现设计基础等效缩放的关键手段，这有助于将前沿技术扩展到更多设计师和新产品。


---
半导体技术缩放（Semiconductor Technology Scaling）是指通过缩小晶体管和其他电子元件的尺寸来提高集成电路（IC）的性能、降低成本和能耗的过程。这个过程是按照一定的比例（通常称为缩放比例或技术节点）进行的，每经过一个技术节点，晶体管的尺寸就会缩小，使得更多的晶体管可以集成到同样大小的芯片上，从而提高芯片的性能和功能。
以下是半导体技术缩放的一些关键点：
1. **尺寸缩小**：随着技术的发展，晶体管的尺寸不断缩小，使得芯片可以容纳更多的晶体管，提高处理能力。
2. **性能提升**：晶体管尺寸的缩小通常会导致开关速度的提高，从而提升芯片的整体性能。
3. **功耗降低**：更小的晶体管在开关时消耗的能量更少，有助于降低芯片的功耗。
4. **成本减少**：随着生产技术的成熟，生产同样功能芯片的成本可能会降低。
5. **摩尔定律**：半导体技术缩放与摩尔定律紧密相关，摩尔定律预测单位面积上的晶体管数量大约每两年翻一番。

半导体技术缩放面临的挑战包括：
- **物理极限**：随着晶体管尺寸接近原子级别，量子效应和其他物理现象开始影响晶体管的行为。
- **设计复杂性**：随着晶体管数量的增加，设计复杂性和验证难度也随之增加。
- **制造难度**：更先进的制造工艺需要更精密的设备和更高的制造成本。
- **热管理**：随着晶体管密度的增加，散热成为一个重要问题。
半导体技术缩放是推动电子行业发展的关键因素之一，它使得电子产品能够不断变得更小、更快、更高效。
---


### 1.2 Challenges of Design QoR Prediction
设计质量结果（Design QoR）是一个漫长（从几天到几个月）的设计过程的结果，这个过程涉及多个复杂的工具，每个工具都包含了众多的优化启发式方法，并为设计师提供了成千上万的命令选项和参数组合。同时，工具版本、工具流程、工艺节点、库和IP、产品目标以及产品设计本身都在不断变化。因此，设计QoR预测面临着几个基本挑战。

+ 有限的样本数据量
+ EDA工具的混沌行为：大量启发式方法的组合，导致EDA工具在运行时产生大量随机性，使得结果出现混沌性，即设计输入有非常小的变化，最终结果变化非常大。
![target clock period变化对actual clock period的影响](img/MLAinEDA_fig_1_1.png)
+ 可操作的预测(Actionable Predictions): 部分预测结果偏离实际应用范围；由于芯片设计是个多阶段工程，应用预测的结果，可能会改变原来的预测结果。
+ 基础设施的需求(Infrastructure Needs)： 
    ---
    为了实现基于机器学习的设计质量结果（QoR）预测，需要构建大量的新基础设施。具体来说，以下四个方面的需求是关键的：
    1. **知识产权保护**：设计所有者、代工厂和EDA提供商需要确保他们的知识产权（设计功能、技术参数、受保护的语法等）得到充分保护。这可能通过标准的匿名化和混淆机制来实现。
    2. **避免知识产权侵权风险**：机器学习研究人员、代工厂和EDA工具用户需要确保他们使用机器学习来改进集成电路（IC）设计启用和流程不会引发知识产权侵权索赔。例如，需要达成共识，是否可以共享基于学习的模型，如延迟计算器的“误差与SPICE”模型。
    3. **吸引学术研究人员**：应吸引学术研究人员参与大量的机器学习建模挑战，并提供支持数据和激励措施（例如，为IC设计中的机器学习创建一个“Kaggle”平台）。
    4. **共享责任和标准化平台**：长期来看，设计、EDA和研究社区必须共同负责部署一个标准的机器学习平台，用于EDA和IC设计建模，该平台涵盖设计指标收集、工具和流程模型生成、设计自适应工具和流程配置，以及工具和流程结果的预测。
    总之，为了推动基于机器学习的IC设计QoR预测，需要建立新的基础设施，确保知识产权保护，避免侵权风险，吸引学术研究，并共同开发一个标准化的机器学习平台。
    ---
+ The Bar for Design QoR Prediction

### 1.3 ML Techniques in QoR Prediction
用于质量质量预测的机器学习技术大致可以分为以下几类:
+ 图形神经网络（GNNs）。电路网表通常被建模为超图或图；因此，将gnn应用于质量质量预测是很自然的。
+ 长短期记忆（LSTM）网络。物理设计的实现实际上是一个分阶段的顺序过程，其中当前阶段的状态在很大程度上取决于以前各阶段的结果。LSTM网络是递归神经网络（RNN）的一种变体，LSTM网络可以通过记忆前阶段的重要信息来捕获这些时间序列信息。
+ 强化学习（RL）。在EDA工具中实现的算法有许多暴露的参数设置，用户可以调整，以实现所需的功率-性能-面积（PPA）结果。虽然物理设计工程师可能会使用不同的工具配置执行大规模并行工具运行，以实现良好的QoR，但这既耗时又资源效率低。强化学习可以训练一个自主代理，迭代地学习调整“循环中没有人”的参数设置。
+ 其他模型。传统的ML技术，如(i)线性回归，（ii）前馈神经网络，（iii）梯度增强的决策树，和（iv）随机森林（RF），也可以用于QoR预测。

### 1.4 Timing Estimation

+ 时序是设计质量结果（QoR）最重要的标准之一。在所有时序指标中，最常用的仍然是最大负松弛（WNS）和总负松弛（TNS）。
+ Timing is one of the most important design QoR criteria. Among all the timing metrics, worst negative slack (WNS) and total negative slack (TNS) are still the most commonly used.

#### 1.4.1 问题定义(Problem Formulation)
+ **背景**：为了达到最佳的最终时序结果，设计团队通常会使用不同的工具配置进行并行物理设计（PD）运行，进行功率、时序和面积的探索。鉴于紧张的流片进度、有限的工具许可和计算资源，这是一个压力非常大的过程。

+ **目标**：在寻求设计实施可能达到的绝对极限时，大多数运行注定会失败，即无法满足给定的时序约束。如果能够在设计流程的早期阶段识别出这些注定失败的运行，那么可以缩短芯片设计的周转时间（TAT），并且更高效地利用计算资源。

在设计的早期阶段，给定一个网表n、时钟周期cp和单元密度d，预测物理设计实施是否能够成功满足时序约束，具体表现为后路由的总负松弛（TNS）。

#### 1.4.2  预测流程(Estimation Flow)

在布局和时钟树综合（CTS）过程中，选择了三个中间物理阶段——详细布局、PlaceOpt和CTSOpt——来进行顺序建模。对于每个中间阶段，使用图神经网络（GNNs）以网表图作为输入来执行每个阶段的总负松弛（TNS）预测。此外，还使用长短期记忆（LSTM）网络通过将三个建模阶段的GNN基于嵌入作为顺序输入来执行最终的TNS预测。一旦所有TNS预测都可用，注定失败的运行将立即终止。

![注定失败运行预测流程概述。](img/MLAinEDA_fig_1_9.png)

#### 1.4.3 特征工程(Feature Engineering)
节点的时序、功率特征从时序报告，功率报告以及技术文档中提取，所有的特征都是基于领域知识人工选择的。

![基于GNN的LSTM注定失败运行预测流程的节点特征](img/MLAinEDA_table_1_1.png)

#### 1.4.4 机器学习引擎(Machine Learning Engines)
图1.10展示了基于GNN的LSTM框架的详细架构。左侧展示了顺序流程建模，其中来自不同物理实施阶段的网表的GNN基于嵌入被作为顺序输入送入LSTM网络。右侧展示了单阶段建模，其中当前阶段的网表的GNN基于嵌入被输入到一个专门的前馈神经网络中，以获得当前阶段的TNS预测。
所有三个物理实施阶段共享同一个GNN模块，从而提高了训练框架的可泛化性。

![基于GNN的LSTM框架的详细架构](img/MLAinEDA_fig_1_10.png)

### 1.5 设计空间探索(Design Space Exploration)
设计空间探索（DSE）是提高设计质量结果（QoR）的一项关键技术。对于给定的设计和物理实施流程，可能存在三种类型的参数：(i) 架构参数，如CPU核心的位宽；(ii) 设计约束，如时钟周期和芯片的裸片尺寸；以及(iii) EDA工具的调节旋钮，如布局引擎的时序驱动和拥塞驱动选项。设计空间探索的最简单方法是在第1.4节提到的，运行大量不同配置的物理设计（PD）运行。然而，近年来，基于机器学习（ML）的自动化设计空间探索越来越受到关注。


#### 1.5.1 问题定义(Problem Formulation)

布局参数优化问题的强化学习（RL）公式定义如下：给定一个网表n，找到p∗ = argminp∈PH P WL(p)，其中P是布局引擎的参数组合集合，HPWL是返回的布局解决方案的后布局半周长线长。

#### 1.5.2 估计流程(Estimation Flow)

为了训练一个自动调整放置引擎的RL代理的参数设置，需要定义以下四个关键元素：状态、动作、状态转移、奖励
+ **状态**： 状态集合包括网表集N和布局引擎的所有可能参数设置（P）。表1.2列出了布局引擎的目标参数，其中包括6×10^9种可能的参数设置。一个单一的状态s由一个唯一的网表n和一个特定的参数设置p组成。

![Targeted parameters of the placement engine](img/MLAinEDA_table_1_2.png)

+ **动作**： 智能体可以用来更新参数设置（即P的值）的动作。在每一episode中，RL智能体不能改变网表。表1.3中展示了11种不同的动作。

![动作集合](img/MLAinEDA_table_1_3.png)

+ **状态转移**： 给定一个状态（St）和一个动作（At），下一个状态（St+1）是具有更新后参数设置的相同的网表。

+ **奖励**： 奖励被定义为布局引擎给出的后布局线长（-HPWL）的负值。如果动作在最小化后布局线长方面改进了参数设置，奖励会增加。为了训练一个智能体，使其在可能在线长方面有显著差异的各种网表上表现良好，奖励通过基准后布局线长进行了归一化。其中，HPWL_Human_Baseline是网表预期的基准后布局线长，可以通过手动运行一次布局引擎来获得。

![Reward](img/MLAinEDA_formula_1_26.png)


强化学习智能体通过与布局引擎的互动学习，以优化布局参数。在每个回合中，智能体根据策略选择动作，并基于布局结果获得奖励。在回合中，网表保持不变，只有参数设置会改变。回合结束时，智能体达到一个终端状态，随后开始新的回合。每个回合持续16个时间步。

![Overview of the RL placement parameter optimization flow](img/MLAinEDA_fig_1_11.png)

#### 1.5.3 特征工程(Feature Engineering)
网表表示包括元知识（number of cells, floorplan area等），图的拓扑特征，和由图神经网络得到的图嵌入。

#### 1.5.4 机器学习引擎(Machine Learning Engines)

智能体由一个深度神经网络表示，如图1.13所示。首先，布局参数p与从输入网表n中提取的特征进行连接，然后通过两个全连接的前馈层（FC层）进行处理，这些层具有tanh激活函数，并接着通过一个FC线性层。之后，引入了一个长短期记忆（LSTM）模块。此外，添加了一个序列到一维的全局注意力机制，以帮助LSTM模块关注递归的重要部分。最后，LSTM模块的隐藏状态被输入到策略网络和价值网络中，这两个网络各自包括两个具有tanh激活函数的FC层。策略网络和价值网络分别使用softmax层和线性层作为输出层。

![RL代理的整体网络架构](img/MLAinEDA_fig_1_13.png)

除了RL智能体的网络架构之外，训练布局参数优化智能体还有两个主要问题：（i）工具运行的延迟，因为执行一次布局可能需要几分钟到几小时；（ii）数据的稀疏性，因为没有可能数百万个网表、布局设计的数据库。为了缓解这两个问题，实现了A2C的并行版本。如图1.14所示，一个智能体通过多个智能体并行地与各自环境的副本交互来学习。通过一个确定性的实现，等待每个智能体完成其经验片段（根据步骤模型提供的当前策略）后，再对网络权重进行一次批量更新。

![同步并行学习器](img/MLAinEDA_fig_1_14.png)

### 1.6 总结(Summary)

在本章中，我们介绍了基于机器学习的设计质量结果（QoR）预测的动机、挑战和基本技术。这种基于ML的设计QoR预测是设计基础等效缩放的一个强大杠杆，可以放大设计师和新产品实现半导体技术效益的能力。然而，实现通用的高质量QoR预测面临着样本数量有限、EDA工具和流程的混沌行为、在给定流程上下文中做出可操作预测的难度以及缺失的基础设施元素等挑战。长期以来，存在替代（如构建性或假设和强制）的设计QoR预测方法，这些方法经过数十年的磨砺，为基于ML的QoR预测的开发和部署带来了额外的挑战。
随着对ML技术（如GNN、LSTM和RL）的理解和理解的进步，研究人员在基于ML的QoR预测领域取得了迅速的进展。本章总结了几个关键技术，并详细描述了在时序估计和设计空间探索上下文中进行设计QoR预测的示例方法。
